# Документация по деплою на VPS

## Архитектура

### Формат запроса

**POST** `/api/deploy/`

**FormData:**
- `site_zip` (File) - ZIP архив с index.html
- `host` (string) - IP адрес или домен VPS
- `port` (number, default: 22) - SSH порт
- `username` (string) - SSH пользователь (не root!)
- `password` (string) - SSH пароль
- `deploy_path` (string) - Путь на VPS (например: /var/www/my-site)
- `domain` (string, optional) - Домен для Nginx конфига
- `nginx_config` (boolean, default: false) - Нужен ли Nginx конфиг

### Безопасность

- ✅ Валидация хоста (IP или домен)
- ✅ Валидация пути (запрет ../, /etc, /root)
- ✅ Запрет использования root пользователя
- ✅ Таймауты SSH (10 сек подключение, 30 сек операция)
- ✅ Временные файлы удаляются в finally
- ✅ Ключи не сохраняются на сервере

### Установка зависимостей

```bash
pip install paramiko>=3.0.0
```

## Использование

### Фронтенд

1. В редакторе нажмите кнопку "Деплой"
2. Заполните форму:
   - IP/домен VPS
   - SSH порт (по умолчанию 22)
   - SSH пользователь (не root)
   - SSH пароль
   - Путь развёртывания
   - (Опционально) Домен и настройка Nginx
3. Нажмите "Развернуть"

### Что происходит:

1. **Сборка HTML**: GrapesJS собирает HTML и CSS
2. **Инлайнинг ресурсов**: Все внешние изображения и шрифты конвертируются в base64
3. **Создание ZIP**: Автономный HTML упаковывается в ZIP
4. **Отправка на бэкенд**: ZIP + параметры отправляются на `/api/deploy/`
5. **Деплой**: Бэкенд подключается к VPS, распаковывает ZIP и загружает файлы

### Ответ API

**Успех:**
```json
{
  "success": true,
  "message": "Файлы успешно загружены в /var/www/my-site",
  "url": "http://example.com",
  "nginx": {
    "success": true,
    "message": "Nginx конфиг успешно применён"
  }
}
```

**Ошибка:**
```json
{
  "success": false,
  "message": "Ошибка подключения к VPS"
}
```

## Требования к VPS

- SSH доступ с паролем (PasswordAuthentication должен быть включён в sshd_config)
- Пользователь с правами на запись в указанный путь
- (Опционально) Nginx установлен и настроен для использования sites-available/sites-enabled

## Ограничения

- Максимальное время выполнения: 30 секунд
- Синхронная обработка (без Celery)
- Одноразовый деплой (ключи не сохраняются)

